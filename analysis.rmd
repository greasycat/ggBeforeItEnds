---
title: "Predicting League of Legends Win rate"
date: October, 2022
---

# Introduction


# Dataset
[Provider](https://www.kaggle.com/datasets/junhachoi/all-ranked-solo-games-on-kr-server-24-hours?select=sat+df.csv)

# Prepare all the package
```{r}
library(tidyverse)
library(tidymodels)
library(corrplot)
library(discrim)
library(poissonreg)
library(corrr)
library(klaR)
library(vroom)
library(MASS)
library(janitor)
tidymodels_prefer()
```

# Exploratory Data analysis
## Pre EDA
As the author of the dataset suggests, the orginal encoding is cp949 (korean encoding). So it is wise to convert it to UTF-8 first to avoid encoding issue

Here I use the `iconv` command line tool to change the encoding
```bash
iconv -f cp949 -t utf-8 league_data.csv > league_data_utf8.csv
```

## Explaination of variables in the dataset
Variables of interest
- KoreanTime: local game time in UTC+9
- championName: factor ()
- championRole

Variables of interest that cannot be fully determined during game preparation stage 
- teamId: 100 (blue team), 200 (red team), system randomly assigned team id. since the game map is not entirely symmetrical, blue and team have some minor differences.
- gameEndedInEarlySurrender: True/False, indicating if one team surrendered before 20 minutes
- gameEndedInSurrender:  True/False, indicating if the game is ended with one team surrendered before the winning condition is met
- teamEarlySurrendered: True/False
- visionScore: Numeric, indicating how much pro/counter-reconnaissance action player performed to get more map information for the team (may vary depends on role, support/jg commonly have higher vision score)
- timePlayed: Numeric, total time played in seconds

Other variables will not be considered as they cannot be determined during game prepare stage.
- totalDamagedDealt: Numeric, indicating total damage value dealt on opponent champions, minions and neutral entity
- totalDamageTaken: Numeric, indicating total damage value taken by the player champion
- totalHeal: Numeric, indicating total health point healed on players champion
- totalMinionsKilled: Numeric, indicating total opponent and neutral minions killed
- totalTimeCCDealt: Numeric, indicating total control (make enemy unable to attack for a period of time) time
- totalTimeSpentDead: 

## Loading the dataset
```{r}

league_all_df <- clean_names(vroom("dataset/league_data.csv"))

colnames(league_all_df)

# Check for problems with vroom function
problematic_row <- vroom::problems(league_all_df)$row

# Remove row 720002
league_all_df <- league_all_df[-problematic_row,]


```

```{r}
# Drop variables that are not needed
league_all_df <- league_all_df %>%
    select(
        -c(summoner_name,
        puuid,
        summoner_id,
        ))
```

Give a list of variables and check for missing data
```{r}
# Get columns with na values
na_columns <- names(which(colSums(is.na(league_all_df)) > 0))
print(na_columns)

# Loop through the columns and filter out not na rows
for (col in na_columns) {
    league_all_df <- league_all_df %>%
        filter(!is.na({{col}}))
}

dim(league_all_df)
```



## Remove invalid games
Remake can be made under 3 minutes if one or more player is disconnected from the game in the first 1:30 minutes
- these game will not provide meaningful information to the model
- however, the game can still run for a period of time after remake voting is passed
- so to be safe, use 5 minutes as boundary


```{r}
league_all_df <- league_all_df %>%
    filter(time_played > 360)
dim(league_all_df)
```

## Conversion and Factor
Convert local time to the time of the day
```{r}
# Set 7 as the morning time
league_all_df <- league_all_df %>%
    mutate(
        hour = strptime(league_all_df$KoreanTime, "%Y-%m-%d %H:%M:%S")$hour - 7)

head(league_all_df$hour)

league_all_df <- league_all_df %>%
    mutate(team = case_when(
        teamId == "100" ~ "blue",
        teamId == "200" ~ "red",
    ))
```

```{r}
league_all_df_factored <- league_all_df %>%
    mutate(
        across(
            c(
                win,
                gameEndedInEarlySurrender,
                gameEndedInSurrender,
                teamEarlySurrendered,
                teamPosition,
                championName),
            as.factor)
    )
levels(league_all_df_factored$win)

league_all_df_factored <- league_all_df_factored %>%
    mutate(across(
            c(
                win,
                gameEndedInEarlySurrender,
                gameEndedInSurrender,
                teamEarlySurrendered
            ),
            ~fct_relevel(., c("TRUE", "FALSE"))))


league_all_df_factored$team <- fct_relevel(league_all_df$team, c("blue", "red"))

levels(league_all_df_factored$team)
levels(league_all_df_factored$teamPosition)
```

## Explore the distribution
```{r}
head(league_all_df_factored)
league_all_numeric <- league_all_df_factored %>%
    select(where(is.numeric)|where(is.factor)) %>%
    select(-c(gameNo,
    playerNo,
    participantId,
    teamId,
    unrealKills,
    teamEarlySurrendered,
    gameEndedInEarlySurrender))

league_all_numeric <- league_all_numeric %>%
    mutate(TimeOfTheDayN = as.numeric(TimeOfTheDay))

league_all_df_factored %>%
    filter(win == 1) %>%
    ggplot(aes(y = win, fill = team)) +
    geom_bar() +
    coord_polar() +
    scale_fill_manual(values=c("blue", "red")) +
    ggtitle("Team blue vs team red win rate")

head(league_all_numeric$Hour, n=20)
correlation <- league_all_numeric %>% correlate()
correlation %>%
  stretch() %>%
  ggplot(aes(x, y, fill = r)) +
  geom_tile() +
  geom_text(aes(label = as.character(fashion(r)))) +
  scale_fill_gradient2(low = "red", mid="white", high = "blue") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
View(head(league_all_df_factored, n=60))
# Generate a table of champion compo for each team
team_compo <- league_all_df_factored %>%
    select(no, team, teamPosition, championName) %>%
    pivot_wider(names_from = c(teamPosition, team),
        values_from = championName,
    )
team_compo
# Join the compo by no
league_all_df_factored <-
    left_join(league_all_df_factored, team_compo, by = "no")

league_all_df_factored <- league_all_df_factored %>%
    drop_na()

dim(league_all_df_factored)
View(head(league_all_df_factored, n=60))
league_team <- league_all_df_factored %>% 
    group_by(no) %>% 
    filter(row_number() == 1) %>% 
    ungroup() %>% 
    select(-c(champion_name)) %>% 
    clean_names()

vroom_write(league_team, "dataset/league_team.csv", delim = ",")


```
# Combining with champion stats
```{r}
champions <- clean_names(vroom("dataset/champions.csv"))

library(stringr)
champions <- champions %>% mutate(champion_name = gsub("\\W", "", champion_name))

name1 <- unique(champions$champion_name)
name2 <- unique(league_all_df_factored$champion_name)
print(name2[!(name2 %in% name1)])

champions <- champions %>% mutate(champion_name = case_when(
    champion_name == "LeBlanc" ~ "Leblanc",
    champion_name == "KaiSa" ~ "Kaisa",
    champion_name == "BelVeth" ~ "Belveth",
    champion_name == "RenataGlasc" ~ "Renata",
    champion_name == "Wukong" ~ "MonkeyKing",
    champion_name == "KhaZix" ~ "Khazix",
    champion_name == "NunuWillump" ~ "Nunu",
    champion_name == "ChoGath" ~ "Chogath",
    champion_name == "Fiddlesticks" ~ "FiddleSticks",
    champion_name == "VelKoz" ~ "Velkoz",
    TRUE ~ champion_name
    ))

champion_role <- champions %>% 
    select(c(champion_name, primary_role))

positions <- colnames(league_cut)[-1:-9]

league_team$top_blue <- with(league_team, champion_role$primary_role[match(top_blue, champion_role$champion_name)])
league_team$jungle_blue <- with(league_team, champion_role$primary_role[match(jungle_blue, champion_role$champion_name)])
league_team$middle_blue <- with(league_team, champion_role$primary_role[match(middle_blue, champion_role$champion_name)])
league_team$bottom_blue <- with(league_team, champion_role$primary_role[match(bottom_blue, champion_role$champion_name)])
league_team$utility_blue <- with(league_team, champion_role$primary_role[match(utility_blue, champion_role$champion_name)])
league_team$top_red <- with(league_team, champion_role$primary_role[match(top_red, champion_role$champion_name)])
league_team$jungle_red <- with(league_team, champion_role$primary_role[match(jungle_red, champion_role$champion_name)])
league_team$middle_red <- with(league_team, champion_role$primary_role[match(middle_red, champion_role$champion_name)])
league_team$bottom_red <- with(league_team, champion_role$primary_role[match(bottom_red, champion_role$champion_name)])
league_team$utility_red <- with(league_team, champion_role$primary_role[match(utility_red, champion_role$champion_name)])

league_team <- league_team %>% drop_na()
```


```{r}

```

# Logistic regression
```{r}
df_split <- initial_split(league_team, prop = 0.8, strata = win)
league_training <- training(df_split)
league_testing <- testing(df_split)
```

```{r}
league_recipe <- league_training %>% 
    select(win, ends_with("_blue") | ends_with("_red")) %>%
    recipe(win ~ .,) %>%
        step_dummy(contains("red")) %>% 
        step_dummy(contains("blue"))
        # step_interact(terms = ~ starts_with("top"):starts_with("top")) %>% 
        # step_interact(terms = ~ starts_with("jungle"):starts_with("jungle")) %>% 
        # step_interact(terms = ~ starts_with("middle"):starts_with("middle")) %>% 
        # step_interact(terms = ~ starts_with("bottom"):starts_with("bottom")) %>% 
        # step_interact(terms = ~ starts_with("utility"):starts_with("utility"))

league_recipe

league_recipe %>% 
    prep() %>% juice()
```

```{r}
# df <- league_training %>% 
#     select(c("top_blue", "top_red", "jungle_blue", "jungle_red", "middle_blue", "middle_red", "bottom_blue", "bottom_red", "utility_blue", "utility_red"))
# 
# df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], as.factor)
# 
# 
# all_combos <- t(combn(names(df),2))
# all_chis <- apply(all_combos, 1, \(x) stats::chisq.test(table(df[x])))
# 
# lbls <- paste0(all_combos[,1],"_",all_combos[,2])
# names(all_chis) <- lbls

# all_chis
```

```{r}
league_folded <- league_team %>% 
    vfold_cv(v = 5, strata = win)
```


```{r}

log_reg <- logistic_reg() %>%
    set_engine("glm") %>%
    set_mode("classification")

log_workflow <- workflow() %>%
    add_model(log_reg) %>%
    add_recipe(league_recipe)


log_fit <- fit_resamples(log_workflow, league_folded)

collect_metrics(log_fit)

# predict(log_fit, new_data = league_testing, type = "prob")
augment(log_fit, new_data = league_testing) %>%
    accuracy(truth = win, estimate = .pred_class)
```

# QDA
```{r}
qda_reg <- discrim_linear() %>%
    set_mode("classification") %>%
    set_engine("MASS")

qda_workflow <- workflow() %>% 
    add_model(qda_reg) %>%
    add_recipe(league_recipe)

qda_fit <- qda_workflow %>% 
    fit(league_training)

predict(qda_fit, league_testing[1:10,])
View(league_testing[1:10,])

augment(log_fit, new_data = league_testing) %>%
    accuracy(truth = win, estimate = .pred_class)
```


